<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <style>
        #buttonsPanel {
            margin: 0px;
            padding: 15px;
            border: 1px solid gray;
        }
        #buttonsPanel input{
            display: inline-block;
            margin : 5px;
            border : 2px blue groove;
            background-color: lightblue;
        }
    </style>
    <title>Correlation</title>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script type="text/javascript" src="math.js"></script>
    <script src="Utilities.js"></script>
    <script src="Correlation.js"></script>

    <script>
        d3.select(window).on('load',init)

        function drawCorrelationsHistogram(weatherAndStationData){


        }

        function init() {
            var width = 960,
                height = 500;

            // setup fill color
            // var cValue = function(d) { return d.Manufacturer;},
            color = d3.scaleOrdinal("schemeCategory10");


            // load data
            d3.csv("AndersenBoulevard.csv", function (error, raw_stationdata) {

                drawScatterplot("NO2", "CO",width, height, raw_stationdata)

                //console.log(raw_stationdata)
                var stationdata = addDateAndTime(raw_stationdata)
                //console.log(stationdata)
                var stationdata = filterDataset(stationdata)
                //console.log(stationdata)

                var air_dimensions = Object.keys(stationdata[0]);
                removeFromArray(air_dimensions, "Time")
                removeFromArray(air_dimensions, "Date")
                removeFromArray(air_dimensions, "Timestamp")

                console.log(air_dimensions)

                d3.csv("WeatherDataset.csv", function(error, raw_weatherdata) {
                    var weatherdata = addDateAndTime(raw_weatherdata)
                    var weatherdata = filterDataset(weatherdata)
                    //console.log(weatherdata)

                    prejoin_stationData = d3.nest().key(function (d) {
                        return d.Timestamp
                    })
                        .rollup(function (arr) {
                            return arr[0]
                        }).entries(stationdata)
                    prejoin_weatherData = d3.nest().key(function (d) {
                        return d.Timestamp
                    })
                        .rollup(function (arr) {
                            return arr[0]
                        }).entries(weatherdata)

                    //console.log(prejoin_stationData)
                   // console.log(prejoin_weatherData)

                    joinedDS = joinDatasets(prejoin_stationData, prejoin_weatherData, "key")
                    weatherAndStation_data = joinedDS.map(function (elem) {
                        return elem.value
                    })

                    console.log(weatherAndStation_data)

                    var weather_dimensions = Object.keys(weatherdata[0]);
                    removeFromArray(weather_dimensions, "Time")
                    removeFromArray(weather_dimensions, "Date")
                    removeFromArray(weather_dimensions, "Timestamp")


                        allOtherDims = air_dimensions.concat(weather_dimensions)
                        corrs = []
                        svg_2 = d3.select("#cHistogram")
                        svg_2.attr("width", width)
                             .attr("height", height);

                    padding = 40;
                    for (i=0; i < allOtherDims.length ; i++){
                        //<input type="button" name="button" id="button1" value="Button text"/>
                        c = allOtherDims[i];
                        d3.select("#buttonsPanel")
                            .append('input')
                            .attr('type', 'button')
                            .attr('name', c)
                            .attr('id',  c)
                            .attr('value',  c)
                            .attr('border', '1px solid gray')
                            .on("click", function(){
                                update(this,allOtherDims);
                            });
                    }

                    function update(pickedDimension,allOtherDims){
                        removeFromArray(allOtherDims,pickedDimension)

                    allOtherDims.forEach(function (otherDim) {
                        //console.log(pickedDimension)
                        //console.log(otherDim)
                        corrs.push(
                            {
                                dimension: otherDim,
                                correlationValue: computeArrayCorrelation(weatherAndStation_data, pickedDimension, otherDim)
                            })
                    }) }





                    //need corrs and rawdata for a new function**********
                    dimensionNames = corrs.map(function (d) {
                        return d.dimension;
                    })
                    var x = d3.scaleBand()
                        .domain(dimensionNames)
                        .rangeRound([0 + padding, width - padding]);

                    var y = d3.scaleLinear()
                        .domain([-1, +1])
                        .range([height - padding, 0 + padding]);

                    var columnOffset = 10;
                    svg_2.selectAll(".bar")
                        .data(corrs.map(function (d) {
                            return d.correlationValue;
                        }))
                        .enter().append("rect")
                        .attr("class", "bar")
                        .attr("x", function (d, i) {
                            return "" + (columnOffset + x(corrs[i].dimension)) + "";
                        })
                        .attr("y", function (d) {
                            if (d < 0) {
                                return y(0)
                            }
                            else {
                                return y(d)
                            }
                        })
                        .attr("fill", function (d) {
                            if (d < 0) {
                                return "orange"
                            }
                            else {
                                return "lightblue"
                            }
                        })

                        .attr("width", width / dimensionNames.length - 30)
                        .attr("height", function (d, i) {
                            return Math.abs(y(d) - y(0))
                        })//height - y(d) - padding; })
                        .on('click', function (d, i) {
                                drawScatterplot(pickedDimension, corrs[i].dimension, width, height, raw_stationdata)
                            }
                        )


                    /** Axis **/
                    svg_2.append("g")
                        .attr("transform", "translate(0," + (height / 2) + ")")
                        .call(d3.axisBottom(x));

                    svg_2.append("g")
                        .attr("transform", "translate(" + padding + ", 0 )")
                        .call(d3.axisLeft(y));

                    /*** Axis labels and Legend ***/
                    // text label for the x axis
                    svg_2.append("text")
                        .attr("transform", "translate(" + width / 2 + " ," +
                            (height - padding + 40) + ")")
                        .style("text-anchor", "middle")
                        .style("font-size", "1.2rem")
                        .text("Air Pollutants");

                    // text label for the y axis
                    svg_2.append("text")
                        .attr("transform", "rotate(-90)")
                        .attr("y", 0 + padding - 60)
                        .attr("x",0 - (height / 2))
                        .attr("dy", "1em")
                        .style("font-size", "1.2rem")
                        .style("text-anchor", "middle")
                        .text("Total number of crimes");
                    //cc12 = computeArrayCorrelation(weatherAndStation_data, variable1, variable2)
                    //console.log(cc12)



                })


            })



        };
    </script>
</head>
<body>


<svg id="forCyclesPivot"></svg>
<svg id="scatterPlot_svg"></svg>
<svg id="cHistogram"></svg>
<div id="buttonsPanel"></div>
</body>
</html>