<!DOCTYPE html>
<html lang="en">
<head>
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type">
    <meta content="utf-8" http-equiv="encoding">
    
    
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="http://code.jquery.com/jquery-1.11.0.min.js"></script>

<script>

function updatePieChart(districtName, crimesByDistrictAndCategory) {
           
            chosenDistrict = crimesByDistrictAndCategory.find(function (elem) { 
                                                             //console.log(elem.key) ; 
                                                             return elem.key === districtName })

            CDcrimeNumbersArray = chosenDistrict.value
            
            /////// This part of the code sort the array of crime categories, and 
            /////// selects the most frequent 6 categories, for the pie visualization
            CDcrimeNumbersArray.sort(function(a,b) {
                if (a.value > b.value) {
                    return -1
                } else
                {
                    return 1
                }
            })
            console.log(CDcrimeNumbersArray)
            mainCrimesNumbersArray = CDcrimeNumbersArray.slice(0,7)            
            console.log(mainCrimesNumbersArray)
            ///////
        
            var margin = {top: 50, right: 50, bottom: 50, left: 50};
            var pie_width =  0.4 * window.screen.width//+svg.node().getBoundingClientRect().width - margin.left - margin.right;
            var pie_height = 0.9 * pie_width//+svg.node().getBoundingClientRect().height - margin.top - margin.bottom;
            var pv_svg = d3.select('#pieVisualization')
                           .style('width', pie_width)
                           .style('height', pie_height)
                           .style('border', '1px solid gray')

            var g = pv_svg.append("g")
                .attr("transform",
                    "translate(" + pie_width / 3 + "," + pie_height / 3 + ")");
                        
            // Create arc-data generator
            var arcs = d3.pie();

            // Create arc path generator
            var arc = d3.arc()
                .innerRadius(10)
                .outerRadius(0.4 * pie_width);

            //Create the 'numbers array' for the arcs creation
            arcsdata = []
            for (i=0; i < mainCrimesNumbersArray.length; i++) {
                c = mainCrimesNumbersArray[i]
                arcsdata.push(c.value)
            }
            console.log(arcsdata)
            
            // Create group element for each data point
            var gInner = g.selectAll('g')
                .data(arcs(arcsdata))
                .enter()
                .append('g')
                .attr('transform', 'translate(100, 100)')

            // Add arc to group elements
            gInner.append('path')
                .attr('d', function(d){//console.log(d); 
                                       return arc(d);})
                .attr("stroke", "blue")
                .attr("stroke-width", 2)
                .attr("fill", "#ccc")
            
            //////// Adding text to the arcs
            t = gInner.append('text')
                //.text(function(d, i){return mainCrimesNumbersArray[i].key + " : " + d.data ;})
                .attr('transform',
                     function(d){return 'translate(' + arc.centroid(d) + ')';})
                .attr('text-anchor', 'middle')
 
            t.append('tspan')
                .text(function(d,i) { return mainCrimesNumbersArray[i].key + " : "})                

            t.append('tspan')
                .attr('dy', 15)
                .attr('x', 0)
                .text(function(d,i) { return d.data})
            ////////

   
    }
    
    
    d3.select(window).on('load', init);
    function init() {
        d3.text('sf_crime.csv', function(error, raw_data){
            var crimeTable = d3.csvParse(raw_data);
            console.log(crimeTable);

            console.log(crimeTable[0]);


            //Creates a multi-level array object, that stores the count of the crimes, per district and per category
            //At the 1st level : [ {key: "INGLESIDE", value: Array(30)}, {key: "BAYVIEW", value: Array(30)} ... ]
            //At the 2nd level, opening up the array associated with each district:
            //[{key: "OTHER OFFENSES", value: 157}, {key: "LARCENY/THEFT", value: 100} , ...]            
            var crimesByDistrictAndCategory = d3.nest()
                                                .key(function(d) { return d.PdDistrict; })
                                                .rollup(function(arr) {
                                                            cc =
                                                            d3.nest()
                                                              .key(function(d) { return d.Category; })
                                                              .rollup(function (crimesArr) { return crimesArr.length })
                                                              .entries(arr);
                                                            return cc})
                                                .entries(crimeTable);

            console.log(crimesByDistrictAndCategory)
            
            
            /////Create one button for each district. 
            /////When a button is pressed, we update accordingly the pie chart
            for (i=0; i < crimesByDistrictAndCategory.length ; i++){
                //<input type="button" name="button" id="button1" value="Button text"/>
                c = crimesByDistrictAndCategory[i]
                d3.select("#districtButtons")
                  .append('input')
                  .attr('type', 'button')
                  .attr('name', c.key)
                  .attr('id',  c.key)
                  .attr('value',  c.key)
                  .attr('border', '1px solid gray')
                  .on("click", function(){
                                    d3.select("pieVisualization").selectAll("*").remove()
                                    updatePieChart(this.id, crimesByDistrictAndCategory)
                                    });
            }
            

        });


    }
</script>
</head>

<body>
    <div id="districtButtons"></div>
    <div>
    <svg id="pieVisualization">
    </svg></div>
    
    
    
    
    
</body>
</html>