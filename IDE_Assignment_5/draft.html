<!DOCTYPE html>
<html lang="en">
<head>
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type">
    <meta content="utf-8" http-equiv="encoding">
    <style>
    input{
        min-width:50px;
        max-width:99.99%;
        text-align:center;
    }
    .infoDiv {
        font-size: 1.05rem;
        font-weight: bold; 
        padding : 5px;
        border: 1px solid gray;
    }
    .infoDiv input{
        margin-left : 20px;  
        border: 2px dotted gray;
    }
    #buttonsPanel {
        margin: 0px;
        padding: 15px;
        border: 1px solid gray;
    }
    #buttonsPanel input{
        display: inline-block;
        margin : 5px;
        border : 2px blue groove;
        background-color: lightblue;
    }
    </style>


<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="http://code.jquery.com/jquery-1.11.0.min.js"></script>


<script>

    //Imported from https://codepen.io/w3core/pen/DjLml to have input fields that dinamycally resize depending on the text
    function resizable (el, factor) {
      var int = Number(factor) || 7.7;
      function resize() {el.style.width = ((el.value.length+1) * int) + 'px'}
      var e = 'keyup,keypress,focus,blur,change'.split(',');
      for (var i in e) el.addEventListener(e[i],resize,false);
      resize();
    }
    
function updatePieChart(districtName, crimesByDistrictAndCategory) {
           
            chosenDistrict = crimesByDistrictAndCategory.find(function (elem) { 
                                                             //console.log(elem.key) ; 
                                                             return elem.key === districtName })

            CDcrimeNumbersArray = chosenDistrict.value
            
            /////// This part of the code sort the array of crime categories, and 
            /////// selects the most frequent 6 categories, for the pie visualization
            CDcrimeNumbersArray.sort(function(a,b) {
                if (a.value > b.value) {
                    return -1
                } else
                {
                    return 1
                }
            })
            console.log(CDcrimeNumbersArray)
            mainCrimesNumbersArray = CDcrimeNumbersArray.slice(0,7)            
            console.log(mainCrimesNumbersArray)
            ///////
        
            var margin = {top: 50, right: 50, bottom: 50, left: 50};
            var pie_width =  0.4 * window.screen.width//+svg.node().getBoundingClientRect().width - margin.left - margin.right;
            var pie_height = 0.9 * pie_width//+svg.node().getBoundingClientRect().height - margin.top - margin.bottom;
            var pv_svg = d3.select('#pieVisualization')
                           .style('width', pie_width)
                           .style('height', pie_height)
                           .style('border', '1px solid gray')

            var g = pv_svg.append("g")
                .attr("transform",
                    "translate(" + pie_width / 3 + "," + pie_height / 3 + ")");
                        
            // Create arc-data generator
            var arcs = d3.pie();

            // Create arc path generator
            var arc = d3.arc()
                .innerRadius(10)
                .outerRadius(0.4 * pie_width);

            //Create the 'numbers array' for the arcs creation
            arcsdata = []
            for (i=0; i < mainCrimesNumbersArray.length; i++) {
                c = mainCrimesNumbersArray[i]
                arcsdata.push(c.value)
            }
            console.log(arcsdata)
            
            // Create group element for each data point
            var gInner = g.selectAll('g')
                .data(arcs(arcsdata))
                .enter()
                .append('g')
                .attr('transform', 'translate(100, 100)')

            // Add arc to group elements
            gInner.append('path')
                .attr('d', function(d){//console.log(d); 
                                       return arc(d);})
                .attr("stroke", "blue")
                .attr("stroke-width", 2)
                .attr("fill", "#ccc")
            
            //////// Adding text to the arcs
            t = gInner.append('text')
                //.text(function(d, i){return mainCrimesNumbersArray[i].key + " : " + d.data ;})
                .attr('transform',
                     function(d){return 'translate(' + arc.centroid(d) + ')';})
                .attr('text-anchor', 'middle')
 
            t.append('tspan')
                .text(function(d,i) { return mainCrimesNumbersArray[i].key + " : "})                

            t.append('tspan')
                .attr('dy', 15)
                .attr('x', 0)
                .text(function(d,i) { return d.data})
            ////////
    
            /////// Updating the fields' text in the HTML
        
            totCrimes = arcsdata.reduce(function(a,b) {return a+b}, 0)
            d3.select("#totCrimesField")
              .attr("value", totCrimes)
              .style("font-weight", "bold")
    
            mainCrime = mainCrimesNumbersArray[0].key
            mainCrimeNumber = mainCrimesNumbersArray[0].value
            d3.select("#mainCatField")
              .attr("value", mainCrime + " (" + mainCrimeNumber + " / " + totCrimes + ")")// + " ( " + mainCrimeNumber + " / " totCrimes + " ) "
              .style("font-weight", "bold")
            resizable(document.getElementById('mainCatField'),7);
   
    }


    d3.select(window).on('load', init);
    function init() {
        
        d3.text('sf_crime.csv', function(error, raw_data){
            var crimeTable = d3.csvParse(raw_data);
            console.log(crimeTable);

            console.log(crimeTable[0]);


            //Creates a multi-level array object, that stores the count of the crimes, per district and per category
            //At the 1st level : [ {key: "INGLESIDE", value: Array(30)}, {key: "BAYVIEW", value: Array(30)} ... ]
            //At the 2nd level, opening up the array associated with each district:
            //[{key: "OTHER OFFENSES", value: 157}, {key: "LARCENY/THEFT", value: 100} , ...]            
            var crimesByDistrictAndCategory = d3.nest()
                                                .key(function(d) { return d.PdDistrict; })
                                                .rollup(function(arr) {
                                                            cc =
                                                            d3.nest()
                                                              .key(function(d) { return d.Category; })
                                                              .rollup(function (crimesArr) { return crimesArr.length })
                                                              .entries(arr);
                                                            return cc})
                                                .entries(crimeTable);

            console.log(crimesByDistrictAndCategory)
            
            /////Create one button for each district. 
            /////When a button is pressed, we update accordingly the pie chart
            for (i=0; i < crimesByDistrictAndCategory.length ; i++){
                //<input type="button" name="button" id="button1" value="Button text"/>
                c = crimesByDistrictAndCategory[i]
                d3.select("#buttonsPanel")
                  .append('input')
                  .attr('type', 'button')
                  .attr('name', c.key)
                  .attr('id',  c.key)
                  .attr('value',  c.key)
                  .attr('border', '1px solid gray')
                  .on("click", function(){
                                    d3.select("pieVisualization").selectAll("*").remove();
                                    d3.select('#currentDistrictField').attr('value', this.id)
                                      .style("font-weight", "bold");
                                    updatePieChart(this.id, crimesByDistrictAndCategory)
                                    });
            }

            var new_data = [];

            for(var i = 0; i < crimesByDistrictAndCategory.length; i++){
                new_data.push(crimesByDistrictAndCategory[i].length);
            }

            var w = 20, h = 50;

            var chart = d3.select(".charts").append("svg")
                .attr("class", "chart")
                .attr("width", w * new_data.length)
                .attr("height", h);

            var x = d3.scalelinear()
                .domain([0, 1])
                .range([0, w]);

            var y = d3.scalelinear()
                .domain([0, 50])
                .rangeRound([0, h]); //rangeRound is used for antialiazing

            // x and y are the lower-left position of the bar
            // width is the width of the bar
            // height is the height of the bar
            // for crisp edges use -.5 (antialiazing)
            chart.selectAll("rect")
                .data(new_data)
                .enter().append("rect")
                .attr("x", function(d) { return ""+xScale(d.key)+""; })
                .attr("y", function(d) { return h - y(d) - .5; })
                .attr("width", w)
                .attr("height", function(d) { return y(d); } );

            // horizontal line for the x-axis
            chart.append("line")
                .attr("x1", 0)
                .attr("x2", w * new_data.length)
                .attr("y1", h - .5)
                .attr("y2", h - .5)
                .style("stroke", "#000");


        });



    }
</script>
</head>

<body>
    <div id="districtButtonsDiv">
    <h3> District exploration </h3>
    <p>Click on a button to display information about the district of your choosing.</p>
    <p>A pie-chart will appear, with the first 7 more frequent categories of crime for a district</p>
    </div>
    <div id="buttonsPanel">
    </div>
    <div>
    <div class="infoDiv">    
        District currently displayed : <input type="text" id="currentDistrictField" value="" readonly>
    </div>
    <div class="infoDiv">    
        Total number of crimes : <input type="text" id="totCrimesField" value="" readonly>
    </div>
    <div class="infoDiv">    
        Most frequent category : <input type="text" id="mainCatField" value="" readonly>
    </div>
    <svg id="pieVisualization">
    </svg>
    </div>
    <div class="charts"></div>
    
    
    
    
    
</body>
</html>